<% sidebar = partial('sidebar_cnf.ejs') %>


<div class="col-sm-9 col-sm-offset-3 col-lg-10 col-lg-offset-2 main">			
	<div class="row">
		<ol class="breadcrumb">
			<li><a href="#"><svg class="glyph stroked home"><use xlink:href="#stroked-home"></use></svg></a></li>
			<li class="active">Configuration</li>
		</ol>
	</div><!--/.row-->

	<h2></h2>
	
	<div class="row">
		<div class="col-lg-12">
			<div class="panel panel-info">
				<div class="panel-heading">Information</div>
					<div class="panel-body">
						<div class="row">
								<div class="col-md-2">
									<label>Product name</label>
								</div>
								<div class="col-md-10">						
									<p>G3 Gateway</p>
								</div>
						</div>				
						<div class="row">
								<div class="col-md-2">
									<label>OS version</label>
								</div>
								<div class="col-md-10" id="id_sys_info">						
									<p>Linux aria 4.4.16 #3 Thu Sep 29 21:43:36 CEST 2016 armv5tejl GNU/Linux</p>
								</div>
						</div>
						<div class="row">
								<div class="col-md-2">
									<label>Application</label>
								</div>
								<div class="col-md-10" id="id_app_info">						
									<p>PLC Manager v1.0</p>
								</div>
						</div>		
						<div class="row">
								<div class="col-md-2">
									<label>Startup Time</label>
								</div>
								<div class="col-md-10" id="id_startup_time">						
									<p>0</p>
								</div>
						</div>				
					</div><!-- /.panel-body -->
			</div><!-- /.panel -->
		</div><!-- /.col-->
	</div><!-- /.row -->

	<div class="row">
		<div class="col-lg-12">
			<div class="panel panel-success">
				<div class="panel-heading">PPP Interface</div>
					<div class="panel-body">
							<div class="row">
								<div class="col-md-3">
									<label>MAC Address (MAC)</label>
								</div>
								<div class="col-md-4" id="id_ppp_mac">
									<p>0</p>
								</div>
							</div>
							<div class="row">						
								<div class="col-md-3">
									<label>Unique Local Address (ULA)</label>
								</div>
								<div class="col-md-4" id="id_ppp_ula">						
									<p>0</p>
								</div>
							</div>
							<div class="row">						
								<div class="col-md-3">
									<label>Link Local Address (LLA)</label>
								</div>
								<div class="col-md-4" id="id_ppp_lla">						
									<p>0</p>
								</div>
							</div>
							<div class="row">
								<div class="col-md-3">
									<label>Routing address</label>
								</div>
								<div class="col-md-4" id="id_ppp_routing">
									<p>0</p>
								</div>
						</div>				
					</div><!-- /.panel-body -->
			</div><!-- /.panel -->
		</div><!-- /.col-->
	</div><!-- /.row -->

	<div class="row">
		<div class="col-lg-12">
			<div class="panel panel-success">
				<div class="panel-heading">PLC Interface</div>
					<div class="panel-body">
							<div class="row">						
								<div class="col-md-3">
									<label>Unique Local Address (ULA)</label>
								</div>
								<div class="col-md-4" id="id_plc_ula">						
									<p>0</p>
								</div>
							</div>
							<div class="row">						
								<div class="col-md-3">
									<label>Link Local Address (LLA)</label>
								</div>
								<div class="col-md-4" id="id_plc_lla">						
									<p>0</p>
								</div>
							</div>
							<div class="row">
								<div class="col-md-3">
									<label>Network prefix</label>
								</div>
								<div class="col-md-4" id="id_plc_prefix">
									<p>0</p>
								</div>
							</div>
							<div class="row">
								<div class="col-md-3">
									<label>Routing address</label>
								</div>
								<div class="col-md-4" id="id_plc_routing">
									<p>0</p>
								</div>
						</div>				
					</div><!-- /.panel-body -->
			</div><!-- /.panel -->
		</div><!-- /.col-->
	</div><!-- /.row -->

	<div class="row">
		<div class="col-lg-12">
			<div class="panel panel-warning">
				<div class="panel-heading">G3 network</div>
					<div class="panel-body">
							<div class="row">						
								<div class="col-md-3">
									<label>PAN Id</label>
								</div>
								<div class="col-md-4" id="id_pan_id">						
									<p>0</p>
								</div>
							</div>
							<div class="row">						
								<div class="col-md-3">
									<label>PSK</label>
								</div>
								<div class="col-md-4" id="id_sec_psk">						
									<p>0</p>
								</div>
							</div>
							<div class="row">						
								<div class="col-md-3">
									<label>GMK</label>
								</div>
								<div class="col-md-4" id="id_sec_gmk">						
									<p>0</p>
								</div>
							</div>	
							<div class="row">						
								<div class="col-md-3">
									<label>Max Hops</label>
								</div>
								<div class="col-md-4" id="id_max_hops">						
									<p>0</p>
								</div>
							</div>	
							<div class="row">						
								<div class="col-md-3">
									<label>Max Join Wait Time</label>
								</div>
								<div class="col-md-4" id="id_max_join_wait_time">						
									<p>0</p>
								</div>
						</div>				
					</div><!-- /.panel-body -->
			</div><!-- /.panel -->
		</div><!-- /.col-->
	</div><!-- /.row -->

	<div class="row">
		<div class="col-lg-12">
			<div class="panel panel-warning">
				<div class="panel-heading">GPRS</div>
					<div class="panel-body">
							<div class="row">		
								<div class="col-md-3">
									<label>GPRS Status</label>
								</div>
								<div class="col-md-4" id="id_gprs_status">						
									<p>Disable</p>
								</div>
							</div>
							<div class="row">		
								<div class="col-md-4" id="id_gprs_status_ctrl">
									<input type="checkbox" name="gprs" id="id_gprs_ctrl" onchange="swap_gprs_status_req(this)"> GPRS Enable<br>
								</div>
						</div>				
					</div><!-- /.panel-body -->
			</div><!-- /.panel -->
		</div><!-- /.col-->
	</div><!-- /.row -->

	<div class="row">
		<div class="col-lg-12">
			<div class="panel panel-warning">
				<div class="panel-heading">PLC Sniffer</div>
					<div class="panel-body">
							<div class="row">		
								<div class="col-md-3">
									<label>PLC Sniffer Status</label>
								</div>
								<div class="col-md-4" id="id_sniffer_status">						
									<p>Disable</p>
								</div>
							</div>
							<div class="row">		
								<div class="col-md-4" id="id_sniffer_status_ctrl">
									<input type="checkbox" name="sniffer" id="id_sniffer_ctrl" onchange="swap_sniffer_status_req(this)"> PLC Sniffer Enable<br>
								</div>
							</div>				
					</div><!-- /.panel-body -->
			</div><!-- /.panel -->
		</div><!-- /.col-->
	</div><!-- /.row -->

	<div class="row">
		<div class="col-lg-12">
			<div class="panel panel-warning">
				<div class="panel-heading">PLC Firmware Update</div>
					<div class="panel-body">
							<div class="row">		
								<div class="col-md-3">
									<button class="btn btn-lg upload-btn" type="button">Upload File</button>
								</div>
								<div class="col-md-4" id="id_upload_file_name">						
									<p style="margin-top: 5%">...</p>
								</div>
							</div>
							<div class="row" padding="25">		
								<div class="progress" margin="50px">
									<div class="progress-bar progress-bar-info" role="progressbar"></div>
								</div>
								<input id="upload-input" type="file" name="uploads[]" multiple="multiple">
							</div>				
					</div><!-- /.panel-body -->
			</div><!-- /.panel -->
		</div><!-- /.col-->
	</div><!-- /.row -->

</div><!--/.main-->

<script src="js/jquery-1.11.1.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="js/chart.min.js"></script>
<script src="js/chart-data.js"></script>
<script src="js/easypiechart.js"></script>
<script src="js/easypiechart-data.js"></script>
<script src="js/bootstrap-datepicker.js"></script>
<script>
    /* Para pedir actualizaciones a Node al cargar la vista */
	$(function(){ 
		// Request. Esta funcion esta en "wscli.js"
		console.log('Configuration view: upd_configuration_req()');
		upd_configuration_req();
	});

	!function ($) {
		$(document).on("click","ul.nav li.parent > a > span.icon", function(){		  
			$(this).find('em:first').toggleClass("glyphicon-minus");	  
		}); 
		$(".sidebar span.icon").find('em:first').addClass("glyphicon-plus");
	}(window.jQuery);

	$(window).on('resize', function () {
	  if ($(window).width() > 768) $('#sidebar-collapse').collapse('show')
	})
	$(window).on('resize', function () {
	  if ($(window).width() <= 767) $('#sidebar-collapse').collapse('hide')
	})

	function refreshConfiguration(data) {
		console.log('Configuration view: PLC Manager refreshConfiguration');
		console.log(data);
		// Update each DIV_ID content

		var sysinfo = data[0] + " " + data[1] + " " + data[2] + " " + data[3] + " " + data[4]
		$('#id_sys_info').html(sysinfo);

		$('#id_startup_time').html(data[5]);

		var appinfo = data[6] + " " + data[7] 
		$('#id_app_info').html(appinfo);

		$('#id_ppp_mac').html(data[8]);
		$('#id_ppp_ula').html(data[9]);
		$('#id_ppp_lla').html(data[10]);
		$('#id_ppp_routing').html(data[11]);

		$('#id_plc_ula').html(data[12]);
		$('#id_plc_lla').html(data[13]);
		$('#id_plc_prefix').html(data[14]);
		$('#id_plc_routing').html(data[15]);

		$('#id_pan_id').html(data[16]);
		$('#id_sec_psk').html(data[17]);
		$('#id_sec_gmk').html(data[18]);
		$('#id_max_hops').html(data[19]);
		$('#id_max_join_wait_time').html(data[20]);

		refreshGPRSstatus(data[21]);
		refreshSnifferstatus(data[22]);
	}
	
	function refreshGPRSstatus(data) {
		console.log('Configuration view: PLC Manager refreshGPRSstatus');
		console.log(data);
		// Update DIV_ID content
		if (data[0] == 1) {
			$('#id_gprs_status_ctrl').html("<input type=\"checkbox\" name=\"gprs\" id=\"id_sniffer_ctrl\" checked onchange=\"swap_gprs_status_req(this)\"> GPRS Enable<br>");
			$('#id_gprs_status').html("Enabled");
			console.log("Enabled")
		} else {
			$('#id_gprs_status_ctrl').html("<input type=\"checkbox\" name=\"gprs\" id=\"id_sniffer_ctrl\" onchange=\"swap_gprs_status_req(this)\"> GPRS Enable<br>");
			$('#id_gprs_status').html("Disabled");
			console.log("Disabled")
		}
	}
	
	function refreshSnifferstatus(data) {
		console.log('Configuration view: PLC Manager refreshSnifferstatus');
		console.log(data);
		// Update DIV_ID content
		if (data[0] == 1) {
			$('#id_sniffer_status_ctrl').html("<input type=\"checkbox\" name=\"sniffer\" id=\"id_sniffer_ctrl\" checked onchange=\"swap_sniffer_status_req(this)\"> PLC Sniffer Enable<br>");
			$('#id_sniffer_status').html("Enabled");
			console.log("Enabled")
		} else {
			$('#id_sniffer_status_ctrl').html("<input type=\"checkbox\" name=\"sniffer\" id=\"id_sniffer_ctrl\" onchange=\"swap_sniffer_status_req(this)\"> PLC Sniffer Enable<br>");
			$('#id_sniffer_status').html("Disabled");
			console.log("Disabled")
		}
	}
	
	$('.upload-btn').on('click', function (){
		$('#upload-input').click();
		$('.progress-bar').text('0%');
		$('.progress-bar').width('0%');
	});

	$('#upload-input').on('change', function(){

	  var files = $(this).get(0).files;

	  if (files.length > 0){
		// create a FormData object which will be sent as the data payload in the
		// AJAX request
		var formData = new FormData();

		// loop through all the selected files and add them to the formData object
		for (var i = 0; i < files.length; i++) {
		  var file = files[i];

		  var file_content = "<p style=\"margin-top: 5%\">" + file.name + "</p>"
		  $('#id_upload_file_name').html(file_content);

		  // add the files to formData object for the data payload
		  formData.append('uploads[]', file, file.name);
		}

		$.ajax({
		  url: '/upload',
		  type: 'POST',
		  data: formData,
		  processData: false,
		  contentType: false,
		  success: function(data){
			  console.log('upload successful!\n' + data);
		  },
		  xhr: function() {
			// create an XMLHttpRequest
			var xhr = new XMLHttpRequest();

			// listen to the 'progress' event
			xhr.upload.addEventListener('progress', function(evt) {

			  if (evt.lengthComputable) {
				// calculate the percentage of upload completed
				var percentComplete = evt.loaded / evt.total;
				percentComplete = parseInt(percentComplete * 100);

				// update the Bootstrap progress bar with the new percentage
				$('.progress-bar').text(percentComplete + '%');
				$('.progress-bar').width(percentComplete + '%');

				// once the upload reaches 100%, set the progress bar text to done
				if (percentComplete === 100) {
				  $('.progress-bar').html('Done');
				}

			  }

			}, false);

			return xhr;
		  }
		});

	  }
	});
	
</script>	